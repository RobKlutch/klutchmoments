Preview activates spotlight with video not ready. rAF not started, sampleTime fixed at 0.0. Requesting prerequisite gating and timebase fix.

Team,

I re-tested with the HUD. The same issues persist, and the HUD now shows why.

Evidence from HUD (screenshot attached)

Prerequisites HUD: effectsMounted=YES, videoReady=NO, contentRect=NULL, canvas=NULL, dpr=2.0, rAFStarted=NO, rAFFrameCount=0, Prerequisites=INVALID.

Timebase: currentVideoTime=0.000s, clipStartOffset=0.000s, sampleTime=0.000s, selectedActivationTime=5.972s.

ID lock: selectedPlayerId=player_9, trackingBoxId=player_9, ID Match=YES, boxTimestamp=0.000s.

Render: hasValidBoxForSelected=YES, isSpotlightActive=YES at t=0.0.

What this proves

The overlay is activating while the video is not ready and the render loop is not running.

sampleTime and boxTimestamp remain at 0.0, so the overlay pins to a stale coordinate.

contentRect and canvas are NULL, which explains the persistent left-edge pinning when anything draws.

Gating is incorrect: isSpotlightActive should be impossible while prerequisites are invalid.

Required fixes

Add a hard prerequisite gate for rendering
Define once and use everywhere:

const requireReady =
  videoReady && contentRect != null && canvas != null;


Do not compute or draw spotlight unless requireReady is true. While false, keep UI responsive and show a non-fatal warning instead of clearing to white.

Correct lifecycle and event ordering

Set videoReady on loadedmetadata and canplay.

After videoReady, compute contentRect with getBoundingClientRect() and create/size the overlay canvas to contentRect * devicePixelRatio. Recompute on resize.

Start a single requestAnimationFrame loop on play. Stop on pause, ended, visibilitychange, and on unmount. No competing timers.

Wire timebase from the video element each frame
Inside the same rAF loop used for drawing:

const t = videoRef.current?.currentTime ?? 0;
const sampleTime = t + clipStartOffset;
assert(sampleTime >= lastSampleTime); // log if not


Per-frame ID→box join by time
For the selected ID:

box = getBoxByIdAtTime(selectedPlayerId, sampleTime, { interpolate: true, window: 1/30 }).

hasValidBoxForSelected = Boolean(box).

If no box, freeze last valid up to N frames, then hide. Do not fall back to proximity while selected.

Single source of truth for the render boolean
Compute once and use for both HUD and renderer:

const canActivateByTime   = sampleTime + EPS >= selectedActivationTime;
const canActivateByManual = manualSelectionInPreview && hasValidBoxForSelected;

const isSpotlightActive =
  requireReady &&
  hasSelectedPlayer &&
  (canActivateByTime || canActivateByManual) &&
  hasValidBoxForSelected;


Add a runtime assert that logs inputs if the HUD and renderer booleans ever differ.

Reset state on stage entry and on selection change

Reset manualSelectionInPreview=false, lastBox=null, smoothing filters, framesSinceLastValid=0, and any freeze flags.

Do not carry Timeline selection flags into Preview.

HUD fields to keep visible for verification

Prereqs: effectsMounted, videoReady, contentRect {w,h}, canvas {w,h}, dpr, rAFStarted, rAFFrameCount.

Timebase: currentVideoTime, clipStartOffset, sampleTime, selectedActivationTime.

Tracking: selectedPlayerId, trackingBoxId, ID Match, boxTimestamp, |boxTimestamp − sampleTime|.

Render: hasValidBoxForSelected, freezeActive, framesSinceLastValid, final isSpotlightActive used by the renderer.

Acceptance criteria to close

isSpotlightActive is false until prerequisites are valid. No overlay at t=0 unless the user selects in Preview at t=0.

After activation, the overlay follows only the selected player smoothly.

Quantitative:

IoU with the selected player box ≥ 0.6 for at least 95% of frames over a 10 s clip at 1080p.

Max positional error ≤ 20 px at 1080p.

Zero frames where the overlay is outside the selected player while a valid box exists.

Provide a 20–30 s screen recording with the HUD showing prerequisites flipping to valid, rAF frame count increasing, sampleTime and boxTimestamp advancing, trackingBoxId === selectedPlayerId, and the overlay adhering throughout. Include commit SHAs.

This remains a blocker. Please confirm ownership and deliver the prerequisite gate, lifecycle ordering, timebase wiring, and the recording above.